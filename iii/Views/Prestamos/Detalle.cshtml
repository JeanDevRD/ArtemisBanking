@model ArtemisBanking.Core.Application.Dtos.Loan.LoanDto
@{
    ViewData["Title"] = "Detalle de Préstamo";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h3>Detalle de Préstamo</h3>
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Número de Préstamo:</strong> @Model.LoanNumber</p>
                            <p><strong>Monto Original:</strong> <span class="h5">@Model.Amount.ToString("C2")</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Tasa de Interés:</strong> @Model.AnnualInterestRate.ToString("F2")% anual</p>
                            <p><strong>Estado:</strong> <span class="badge bg-@(Model.IsActive ? "success" : "danger")">@(Model.IsActive ? "Activo" : "Inactivo")</span></p>
                        </div>
                    </div>
                    <hr />
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Fecha de Aprobación:</strong> @Model.ApprovedAt.ToString("dd/MM/yyyy")</p>
                            <p><strong>Plazo:</strong> @Model.TermMonths meses</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Cuotas Pagadas:</strong> @(Model.Installments?.Count(i => i.IsPaid) ?? 0) / @(Model.Installments?.Count() ?? 0)</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <h5>Cuotas Pendientes</h5>
                @if (Model.Installments != null && Model.Installments.Any(i => !i.IsPaid))
                {
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha Vencimiento</th>
                                    <th>Monto</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var cuota in Model.Installments.Where(i => !i.IsPaid).OrderBy(i => i.DueDate))
                                {
                                    <tr>
                                        <td>@cuota.Id</td>
                                        <td>@cuota.DueDate.ToString("dd/MM/yyyy")</td>
                                        <td>@cuota.PaymentAmount.ToString("C2")</td>
                                        <td><span class="badge bg-warning">Pendiente</span></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <a asp-controller="Prestamos" asp-action="PagarCuota" asp-route-id="@Model.Id" class="btn btn-primary mt-2">Pagar Cuota</a>
                }
                else
                {
                    <p class="text-muted">Todas las cuotas han sido pagadas.</p>
                }
            </div>
        </div>

        <div class="col-md-4">
            <h5>Información del Préstamo</h5>
            <div class="card">
                <div class="card-body">
                    <p><strong>Capital Pagado:</strong></p>
                    @{
                        var totalPagado = Model.Installments?.Where(i => i.IsPaid).Sum(i => i.PaymentAmount) ?? 0m;
                        var porcentajePagado = Model.Amount > 0 ? (totalPagado / Model.Amount) * 100m : 0m;
                    }
                    <div class="progress" role="progressbar" aria-valuenow="@((int)porcentajePagado)" aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-bar bg-success" style="width: @porcentajePagado%">
                            @porcentajePagado.ToString("F1")%
                        </div>
                    </div>
                    <small>@totalPagado.ToString("C2") de @Model.Amount.ToString("C2")</small>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">Volver</a>
    </div>
</div>
